version: '3'

tasks:

  # === Version Management ===

  default:
    cmds:
      - task: current
    silent: true

  current:
    desc: Display the current project version (default version task)
    cmds:
      - cmd: echo "v$(task version:pyproject)"
        silent: true

  pyproject:
    desc: Extract version from pyproject.toml (internal task)
    cmds:
      - python3 -c "import tomllib; f = open('pyproject.toml', 'rb'); data = tomllib.load(f); f.close(); print(data['project']['version'])"
    silent: true

  _bumper:
    desc: Internal task to bump version (use version:bump, version:bump:minor, or version:bump:major)
    internal: true
    cmds:
      - cmd: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "‚ùå Error: There are uncommitted changes. Please commit or stash them first."
            exit 1
          fi
        silent: true
      - cmd: echo "üìà Bumping {{.LEVEL}} version..."
        silent: true
      - uv run version_bumper bump {{.LEVEL}}
      - cmd: echo "‚úÖ Version bumped! New version:"
        silent: true
      - task: current
      - cmd: |
          NEW_VERSION=$(task version:pyproject)
          git add pyproject.toml
          git commit -m "chore: bump version to ${NEW_VERSION}"
          echo "‚úÖ Changes committed"
        silent: true
      - cmd: echo "üí° Run 'task release' to prepare and build the release"
        silent: true
    silent: true

  bump:
    desc: Bump the patch version in pyproject.toml
    cmds:
      - task: _bumper
        vars:
          LEVEL: patch

  bump:minor:
    desc: Bump the minor version in pyproject.toml
    cmds:
      - task: _bumper
        vars:
          LEVEL: minor

  bump:major:
    desc: Bump the major version in pyproject.toml
    cmds:
      - task: _bumper
        vars:
          LEVEL: major

  # === Help ===
  help:
    desc: Show available tasks from this Taskfile
    cmd: taskfile-help version
    silent: true
