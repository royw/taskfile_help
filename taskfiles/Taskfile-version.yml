version: '3'

tasks:

  # === Version Management ===

  # `task env` is equivalent to `task env:check`
  # intentionally not using a desc:, instead the check: task has the description and indicates it is the default task
  default:
    cmds:
      - task: current
    silent: true

  current:
    desc: Display the current project version (default version task)
    summary: Shows the version from pyproject.toml with 'v' prefix
    cmds:
      - echo "v$(task version:pyproject)"
    silent: true

  pyproject:
    desc: Extract version from pyproject.toml (internal task)
    summary: Returns raw version number without prefix
    cmds:
      - python3 -c "import tomllib; f = open('pyproject.toml', 'rb'); data = tomllib.load(f); f.close(); print(data['project']['version'])"
    silent: true

  _bumper:
    desc: Internal task to bump version (used by version:bump, version:bump:minor, or version:bump:major)
    summary: Validates clean git state, bumps version, commits changes
    internal: true
    cmds:
      - |
          if [ -n "$(git status --porcelain)" ]; then
            echo "‚ùå Error: There are uncommitted changes. Please commit or stash them first."
            exit 1
          fi
      - echo "üìà Bumping {{.LEVEL}} version..."
      - uv run version_bumper bump {{.LEVEL}}
      - echo "‚úÖ Version bumped! New version:"
      - task: current
      - |
          NEW_VERSION=$(task version:pyproject)
          git add pyproject.toml
          git commit -m "chore: bump version to ${NEW_VERSION}"
          echo "‚úÖ Changes committed"
      - echo "üí° Run 'task release' to prepare and build the release"
    silent: true

  bump:
    desc: Bump the patch version in pyproject.toml
    summary: Increments patch version (e.g., 1.2.3 ‚Üí 1.2.4) and commits
    cmds:
      - task: _bumper
        vars:
          LEVEL: patch

  bump:minor:
    desc: Bump the minor version in pyproject.toml
    summary: Increments minor version (e.g., 1.2.3 ‚Üí 1.3.0) and commits
    cmds:
      - task: _bumper
        vars:
          LEVEL: minor

  bump:major:
    desc: Bump the major version in pyproject.toml
    summary: Increments major version (e.g., 1.2.3 ‚Üí 2.0.0) and commits
    cmds:
      - task: _bumper
        vars:
          LEVEL: major
