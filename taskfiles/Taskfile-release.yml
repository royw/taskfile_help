version: '3'

tasks:

  default:
    cmds:
      - task: build
    silent: true

  # === Release Management ===

  build:
    desc: Prepare and build a release, run after version:bump (default release task)
    summary: Validates readiness, runs tests, updates CHANGELOG, builds packages
    cmds:
      - cmd: echo "üîç Verifying release readiness..."
        silent: true
      - |
        # Check for uncommitted changes
        if [ -n "$(git status --porcelain)" ]; then
          echo "‚ùå Error: There are uncommitted changes. Please commit or stash them first."
          git status --short
          exit 1
        fi
        echo "‚úÖ Working directory is clean"
      - |
        # Check if version has changed from last release
        CURRENT_VERSION=$(task version:pyproject)
        LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
        LAST_VERSION=${LAST_TAG#v}
        
        if [ "$CURRENT_VERSION" = "$LAST_VERSION" ]; then
          echo "‚ùå Error: Version $CURRENT_VERSION matches last release $LAST_TAG"
          echo "üí° Run 'task version:bump' first to bump the version"
          exit 1
        fi
        echo "‚úÖ Version changed: $LAST_VERSION ‚Üí $CURRENT_VERSION"
      - |
        # Check CHANGELOG has unreleased content
        if ! grep -q "## \[Unreleased\]" CHANGELOG.md; then
          echo "‚ùå Error: No [Unreleased] section found in CHANGELOG.md"
          exit 1
        fi
        
        if ! grep -A 5 "## \[Unreleased\]" CHANGELOG.md | grep -q "^- \|^### "; then
          echo "‚ùå Error: [Unreleased] section is empty"
          echo "üí° Commit your changes first to auto-update CHANGELOG"
          exit 1
        fi
        
        # Show what will be released
        echo "üìã Changes to be released:"
        echo "----------------------------------------"
        awk '/## \[Unreleased\]/,/^## \[[0-9]/ {if (/^## \[[0-9]/) exit; print}' CHANGELOG.md | head -30
        echo "----------------------------------------"
      - cmd: echo "üß™ Running full test suite..."
        silent: true
      - cmd: task make
      - cmd: echo "‚úÖ All tests passed!"
        silent: true
      - cmd: echo "üìù Preparing CHANGELOG for release..."
        silent: true
      - |
        NEW_VERSION=$(task version:pyproject)
        TODAY=$(date +%Y-%m-%d)
        
        # Move [Unreleased] content to new version section
        # Add empty [Unreleased] section for future development
        sed -i.bak "s/## \[Unreleased\]/## [Unreleased]\n\n### Added\n\n### Changed\n\n### Fixed\n\n## [$NEW_VERSION] - $TODAY/" CHANGELOG.md
        
        rm CHANGELOG.md.bak
        echo "‚úÖ CHANGELOG.md prepared for v$NEW_VERSION"
      - cmd: echo "üìù Committing release preparation..."
        silent: true
      - |
        NEW_VERSION=$(task version:pyproject)
        git add pyproject.toml CHANGELOG.md
        git commit -m "chore: prepare release v$NEW_VERSION" --no-verify
        echo "‚úÖ Committed release preparation for v$NEW_VERSION"
      - cmd: echo "üèóÔ∏è  Building release package..."
        silent: true
      - cmd: task build
      - |
        # Commit uv.lock if it was changed by the build
        if [ -n "$(git status --porcelain uv.lock)" ]; then
          NEW_VERSION=$(task version:pyproject)
          git add uv.lock
          git commit -m "chore: update uv.lock for v$NEW_VERSION" --no-verify
          echo "‚úÖ Committed updated uv.lock"
        fi
      - cmd: echo "‚úÖ Release v$NEW_VERSION ready!"
        silent: true
      - cmd: 'echo "üìå Next steps:"'
        silent: true
      - cmd: 'echo "   ‚Ä¢ Tag release: task release:tag"'
        silent: true
      - cmd: 'echo "   ‚Ä¢ Or continue development (changes will go to next release)"'
        silent: true
    silent: true

  tag:
    desc: Create and push a git tag for the current version
    summary: Tags the current version and pushes to origin
    deps:
      - version:current
    cmds:
      - |
        VERSION=$(task version:pyproject)
        echo "Creating tag v$VERSION..."
        git tag "v$VERSION"
        git push origin "v$VERSION"
        echo "‚úÖ Tag v$VERSION created and pushed to origin!"

  # === Help ===
  help:
    desc: Show available tasks from this Taskfile
    summary: Displays release management tasks
    cmd: taskfile-help release
    silent: true
