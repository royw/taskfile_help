version: '3'

vars:
  SRC:
    sh: python3 -c "import tomllib; f = open('pyproject.toml', 'rb'); data = tomllib.load(f); f.close(); print(data.get('tool', {}).get('dev-metrics', {}).get('src-paths', 'src/'))"

tasks:

  default:
    cmds:
      - task: summary
    silent: true

  # === Metrics ===

  summary:
    desc: Display comprehensive project metrics summary, config in pyproject.toml (default metrics task)
    cmds:
      - uv run python scripts/dev-metrics.py

  complexity:
    desc: Analyze code complexity with radon
    cmds:
      - cmd: echo "Checking complexity..."
        silent: true
      - cmd: |
          # Read exclusion list from pyproject.toml
          EXCLUDED=$(uv run --quiet python -c "
          import sys
          import tomllib
          try:
              with open('pyproject.toml', 'rb') as f:
                  data = tomllib.load(f)
              project_name = data.get('project', {}).get('name')
              if not project_name:
                  print('', file=sys.stderr)
                  sys.exit(0)
              excludes = data.get('tool', {}).get(project_name, {}).get('complexity', {}).get('exclude', [])
              if not excludes:
                  print('', file=sys.stderr)
                  sys.exit(0)
              # Escape dots and underscores for regex
              pattern = '|'.join(e.replace('.', r'\.').replace('_', r'_') for e in excludes)
              print(pattern)
          except Exception as e:
              print(f'Warning: Could not read exclusion list from pyproject.toml: {e}', file=sys.stderr)
              sys.exit(0)
          " 2>/dev/null)
          
          if [ -z "$EXCLUDED" ]; then
            # No exclusion list, show all results
            uv run radon cc --show-complexity {{.CLI_ARGS | default .SRC}} --min B
          else
            OUTPUT=$(uv run radon cc --show-complexity {{.CLI_ARGS | default .SRC}} --min B | \
            grep -vE "($EXCLUDED)")
            
            if [ -z "$OUTPUT" ] || echo "$OUTPUT" | grep -qE "^src/.*\.py$" && ! echo "$OUTPUT" | grep -qE "^\s+[MFC]"; then
              echo "âœ… No complexity issues found (all B-rated functions are in exclusion list)"
            else
              echo "$OUTPUT"
            fi
          fi
        silent: true
